<!DOCTYPE html>
<html>
    <head>
        <title>Input In Container Fixed To Top Of Viewport | datetimepicker Tests</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" type="text/css" href="jquery.datetimepicker.css"/>


		<style>		
			.noselect {
			  -webkit-touch-callout: none; /* iOS Safari */
				-webkit-user-select: none; /* Safari */
				 -khtml-user-select: none; /* Konqueror HTML */
				   -moz-user-select: none; /* Firefox */
					-ms-user-select: none; /* Internet Explorer/Edge */
						user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
			}

			#dtp_calendar {
				display:inline-block;
			}

			td {
				text-align: center;
				vertical-align:center;

				-webkit-touch-callout: none; /* iOS Safari */
				-webkit-user-select: none; /* Safari */
				 -khtml-user-select: none; /* Konqueror HTML */
				   -moz-user-select: none; /* Firefox */
					-ms-user-select: none; /* Internet Explorer/Edge */
						user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
			}

			#dtp_header {
				display: flex;
				justify-content: space-between;
			}
			
			.table_cell  {
				padding: 0px;
				width: 35px;
				height: 35px;
			}

			
			td > div {
				width: 100%;
				height: 100%;
			}
			
			td > div > p {
				margin: 0;
				position: relative;
				top: 50%;
				left: 50%;
				-ms-transform: translate(-50%, -50%);
				transform: translate(-50%, -50%);
			}
			
			.selected_cell > div {
				background-color: lightblue;
				
				width: 75%;
				height: 75%;
				margin: auto;
				
				border-radius: 50%;
			}
		</style>
    </head>

    <body>
		<div id="dtp_calendar"></div>

        <script>
			// creates an n-dimensional array createArray(length...)
			function createArray(length) {
				var arr = new Array(length || 0);
				var i = length;

				for (var i = 0; i < length; i++) {
					arr[i] = 0;
				}

				if (arguments.length > 1) {
					var args = Array.prototype.slice.call(arguments, 1);
					while (i--) {
						arr[length-1 - i] = createArray.apply(this, args);
					}
				}

				return arr;
			}

			function indexOf (array, value, compareFn) {
				for (var idx = 0; idx < array.length; idx++) {
					if (compareFn(array[idx], value)) {
						return idx;
					}
				}
				
				return -1;
			}
		
			function compareTwoDates (dateA, dateB) {
				if (dateA.getTime() === dateB.getTime()) {
					return true;
				}
				
				return false;
			}
						
			// check how many days in a month code from https://dzone.com/articles/determining-number-days-month
			function daysInMonth(iMonth, iYear) {
				return 32 - new Date(iYear, iMonth, 32).getDate();
			}
		
			// get week number adapted from https://stackoverflow.com/questions/7765767/show-week-number-with-javascript
			function getWeek (date) {
				var onejan = new Date(date.getFullYear(), 0, 4);
				return Math.ceil((((date - onejan) / 86400000) + onejan.getDay() + 1) / 7);
			}
		
			function getDaysOfTheWeek () {
				return [
					"Sun",
					"Mon",
					"Tue",
					"Wed",
					"Thu",
					"Fri",
					"Sat"
				];
			}

			function buildCalendarArray (month, year) {				
				// prepare some metadata about the given month and year
				var d = new Date(year, month);
			    let firstDay = d.getDay();
			    let firstWeek = getWeek(d);

				var dayCounter = 1;
				var numDaysInMonth = daysInMonth(month, year);
				
				// loop over each element in the table array
				for (var rowIdx = 0; rowIdx < numRows; rowIdx++) {
					tableArray[rowIdx][0] = firstWeek + rowIdx;
					
					for (var colIdx = 1; colIdx < numCols; colIdx++) {
						if (rowIdx === 0 && colIdx <= firstDay) {
							// if cell is before the current month ?? intuitively < makes sense not <=
							tableArray[rowIdx][colIdx] = "";
						} else if (dayCounter > numDaysInMonth) {
							// if cell is after the current month
							tableArray[rowIdx][colIdx] = "";
						} else {
							tableArray[rowIdx][colIdx] = new Date(year, month, dayCounter);
							dayCounter++;
						}
					}
				}

				return {
					data: tableArray,
					rows: numRows,
					cols: numCols
				};
			}

			function buildTableCell (innerHTML, id) {
				var tableCell = document.createElement("td");
				tableCell.className = "table_cell";
				tableCell.id = id;
				
				var tableCellDiv = document.createElement("div");
				var tableCellP = document.createElement("p");
				
				tableCellP.innerHTML = innerHTML;
			
				tableCellDiv.appendChild(tableCellP);
				tableCell.appendChild(tableCellDiv);
				
				return tableCell;
			}

			function buildCalendarTableHead () {
				var headRow = document.createElement("tr");
				
				headRow.appendChild(document.createElement("td")); // empty placeholder for week number

				// build td for each day
				getDaysOfTheWeek().forEach ((item, index) => {
					var dotwCell = buildTableCell("", "");
					
					dotwCell.dataset.row = -1;
					dotwCell.dataset.col = index;
					dotwCell.onclick = function () {
						onCellClick([this.dataset.row, this.dataset.col], false, true);
					};

					dotwCell.innerHTML = "<b>" + item + "</b>";


					headRow.appendChild(dotwCell);
				});

				// build the top level parent
				var headRoot = document.createElement("thead");
				headRoot.appendChild(headRow);
				
				return headRoot;
			}
			
			function buildCalendarTableBody (tableData) {
				var tableBody = document.createElement("tbody");
				
				for (var rowIdx = 0; rowIdx < tableData.rows; rowIdx++) {
					var tableRow = document.createElement("tr");
					tableRow.id = "week-" + rowIdx;
					
					// week idx
					var weekIdxCell = buildTableCell("", "week-" + rowIdx);
					weekIdxCell.dataset.row = rowIdx;
					weekIdxCell.dataset.col = -1;
					weekIdxCell.innerHTML = "<b>" + tableData.data[rowIdx][0] + "</b>";
					weekIdxCell.onclick = function () {
						onCellClick([this.dataset.row, this.dataset.col], true, false);
					};

					tableRow.appendChild(weekIdxCell);	
					
					for (var colIdx = 1; colIdx < tableData.cols; colIdx++) {
						if (tableData.data[rowIdx][colIdx] === "") {
							tableRow.appendChild(buildTableCell("", ""));	
						} else {  
							var day = new Date(tableData.data[rowIdx][colIdx]);
							var dayCell = buildTableCell(day.getDate(), "");
							
							dayCell.classList.add("day_cell");
							
							dayCell.dataset.row = rowIdx;
							dayCell.dataset.col = colIdx-1;
							
							dayCell.dataset.day = day.getDate();
							dayCell.dataset.month = day.getMonth();
							dayCell.dataset.year = day.getFullYear();
							
							dayCell.onclick = function () {
								onCellClick([this.dataset.row, this.dataset.col], false, false);
							};
							
							tableRow.appendChild(dayCell);	
						}
					}

					// after constructing the row, append it to the body
					tableBody.appendChild(tableRow);
				}

				return tableBody;
			}

			function buildCalendarHeader () {
				var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

				var leftArrow = document.createElement("button");
				leftArrow.id = "leftArrowSelector";
				leftArrow.innerHTML = "<";
				
				if (curDate <= minDate) {
					leftArrow.style.visibility = "hidden";
				}
				
				leftArrow.onclick = function () {
					var curMonth = curDate.getMonth();
					var curYear = curDate.getFullYear();
					
					curMonth -= 1;

					if (curMonth < 0) {
						curMonth = 11;
						curYear -= 1;
					}

					curDate = new Date(curYear, curMonth);;
					showCalendar(curDate);
				};
				
				var rightArrow = document.createElement("button");
				rightArrow.id = "rightArrowSelector";
				rightArrow.innerHTML = ">";
				rightArrow.onclick = function () {
					var curMonth = curDate.getMonth();
					var curYear = curDate.getFullYear();
					
					curMonth += 1;
					
					if (curMonth > 11) {
						curMonth = 0;
						curYear += 1;
					}

					curDate = new Date(curYear, curMonth);
					showCalendar(curDate);
				};
				
				if (curDate >= maxDate) {
					rightArrow.style.visibility = "hidden";
				}
				
				var title = document.createElement("span");
				title.innerHTML = months[curDate.getMonth()] + "&emsp;" + curDate.getFullYear();
				title.classList.add("noselect");
				
				var headerParent = document.createElement("div");
				headerParent.id = "dtp_header";
				
				headerParent.appendChild(leftArrow);
				headerParent.appendChild(title);
				headerParent.appendChild(rightArrow);
				
				return headerParent;
			}

			function showCalendar (curDate) {
				// month [1, 12] year (eg. 2019)
				var calendarDiv = document.getElementById("dtp_calendar");
				calendarDiv.innerHTML = "";

				var tableData = buildCalendarArray(curDate.getMonth(), curDate.getFullYear());

				// --------------------------------------------------------
				var parent = document.createElement("div");

				parent.appendChild(buildCalendarHeader());
				
				var tableParent = document.createElement("table");
				tableParent.rules="groups";
				
				tableParent.appendChild(buildCalendarTableHead());
				tableParent.appendChild(buildCalendarTableBody(tableData));
				parent.appendChild(tableParent);
				
				calendarDiv.appendChild(parent);
				// --------------------------------------------------------
				
				// toggle all of the selected dates on
				selectDates(selectedDates);
				
				return tableData;
			}

			function toggleCell (rowIdx, colIdx) {
				var rowQuery = "[data-row='" + rowIdx + "']";
				var colQuery = "[data-col='" + colIdx + "']";
				var classQuery = ".day_cell";

				var cell = document.querySelectorAll(classQuery + rowQuery + colQuery)[0];
	
				var cellDate = new Date(
					cell.dataset.year,
					cell.dataset.month,
					cell.dataset.day,
				);

				if (cell.classList.toString().includes("selected_cell")) {
					cell.classList.remove("selected_cell");
					
					var index = indexOf(selectedDates, cellDate, compareTwoDates);
					if (index > -1) {
						selectedDates.splice(index, 1);
					}
				} else {
					cell.classList.add("selected_cell");
					
					if (indexOf(selectedDates, cellDate, compareTwoDates) === -1) {
						selectedDates.push(cellDate);
					}
				}

				return [cell];
			}
			
			function toggleCol (colIdx) {
				var colQuery = "[data-col='" + colIdx + "']";
				var classQuery = ".day_cell";

				var cells = document.querySelectorAll(classQuery + colQuery);
				
				for (var cellIdx = 0; cellIdx < cells.length; cellIdx++) {
					var cell = cells[cellIdx];
					
					var cellDate = new Date(
						cell.dataset.year,
						cell.dataset.month,
						cell.dataset.day
					);
					
					if (cell.classList.toString().includes("selected_cell")) {
						cell.classList.remove("selected_cell");
						
						var index = indexOf(selectedDates, cellDate, compareTwoDates);
						if (index > -1) {
							selectedDates.splice(index, 1);
						}
					} else {
						cell.classList.add("selected_cell");
						
						if (indexOf(selectedDates, cellDate, compareTwoDates) === -1) {
							selectedDates.push(cellDate);
						}
					}
				}

				return cells;
			}
			
			function toggleRow (rowIdx) {
				var rowQuery = "[data-row='" + rowIdx + "']";
				var classQuery = ".day_cell";

				var cells = document.querySelectorAll(classQuery + rowQuery);

				for (var cellIdx = 0; cellIdx < cells.length; cellIdx++) {
					var cell = cells[cellIdx];

					var cellDate = new Date(
						cell.dataset.year,
						cell.dataset.month,
						cell.dataset.day
					);

					if (cell.classList.toString().includes("selected_cell")) {					
						cell.classList.remove("selected_cell");

						var index = indexOf(selectedDates, cellDate, compareTwoDates);
						console.log(index);
						if (index > -1) {
							selectedDates.splice(index, 1);
						}
					} else {
						cell.classList.add("selected_cell");
						
						if (indexOf(selectedDates, cellDate, compareTwoDates) === -1) {
							selectedDates.push(cellDate);
						}
					}
				}
				
				return cells;
			}
			
			function selectDates (dateArray) {
				for (var idx = 0; idx < dateArray.length; idx++) {
					var dayQuery = "[data-day='" + dateArray[idx].getDate() + "']";
					var monthQuery = "[data-month='" + dateArray[idx].getMonth() + "']";
					var yearQuery = "[data-year='" + dateArray[idx].getFullYear() + "']";

					var dayCell = document.querySelectorAll(dayQuery + monthQuery + yearQuery)[0];
					
					if (typeof dayCell !== "undefined") {
						if (!(dayCell.classList.toString().includes("selected_cell"))) {					
							dayCell.classList.add("selected_cell");
						}
					}
				}
			}
			
			// 5 rows, 8 columns (1 for week num, 7 for dotw)
			var numRows = 6; 
			var numCols = 8;
			
			var selectedDates = [];
			
			// tableArray maintains the table data
			var tableArray = createArray(numRows, numCols);
        </script>

		<script>
			var curDate = new Date(2019, 9);
			var minDate = new Date(2019, 8);
			var maxDate = new Date(2019, 10);

			showCalendar(curDate);

			function onCellClick (cellIdx, isWeekSelectionToggle, isDaySelectionToggle) {
				var changedCells = [];
			
				if (isWeekSelectionToggle) {
					changedCells = toggleRow(cellIdx[0]);
				} else if (isDaySelectionToggle) {
					changedCells = toggleCol(cellIdx[1]);
				} else {
					changedCells = toggleCell(cellIdx[0], cellIdx[1]);
				}
			}
		</script>
    </body>
</html>
